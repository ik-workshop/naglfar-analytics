flowchart TD
    Start([Incoming HTTP Request]) --> Metrics[Prometheus HTTP Metrics Middleware]
    Metrics --> AuthMW[Authentication Middleware]

    AuthMW --> InfraCheck{Is Infrastructure<br/>Endpoint?}

    InfraCheck -->|"/healthz"| HealthzHandler[Local Handler:<br/>Health Check]
    InfraCheck -->|"/readyz"| ReadyzHandler[Local Handler:<br/>Readiness Check]
    InfraCheck -->|"/metrics"| MetricsHandler[Local Handler:<br/>Prometheus Metrics]
    InfraCheck -->|"/api/v1/info"| InfoHandler[Local Handler:<br/>Service Info]
    InfraCheck -->|"/swagger/*"| SwaggerHandler[Local Handler:<br/>API Documentation]

    InfraCheck -->|No - Other Path| AuthCheck{Has<br/>AUTH-TOKEN<br/>Header?}

    AuthCheck -->|Yes| YARPProxy[YARP Reverse Proxy]
    YARPProxy --> Backend[Backend Service<br/>protected-service-eu:8000]
    Backend --> Response1[HTTP Response]

    AuthCheck -->|No| GenerateEToken[Always Generate New<br/>E-TOKEN UUID<br/>Ignore existing E-TOKEN]

    GenerateEToken --> SetHeader[Set E-TOKEN Header]
    SetHeader --> Redirect[302 Redirect to Auth Service]

    Redirect --> RedirectURL[Location: auth-service?<br/>return_url=original_path<br/>&e_token=uuid]
    RedirectURL --> AuthService[Auth Service<br/>localhost:8090/auth]

    AuthService --> UserAuth[User Authenticates]
    UserAuth --> SetAuthHeader[Auth Service Sets<br/>AUTH-TOKEN Header]
    SetAuthHeader --> RedirectBack[Redirect Back to<br/>Original return_url]
    RedirectBack --> Start

    HealthzHandler --> Response2[HTTP Response]
    ReadyzHandler --> Response2
    MetricsHandler --> Response2
    InfoHandler --> Response2
    SwaggerHandler --> Response2

    style InfraCheck fill:#e1f5ff
    style AuthCheck fill:#fff4e1
    style YARPProxy fill:#e8f5e9
    style Redirect fill:#ffebee
    style AuthMW fill:#f3e5f5
