# Naglfar Event Consumer

A .NET 10.0 Worker Service that consumes E-TOKEN events from Redis pub/sub and processes them for analytics.

## Overview

The **Naglfar Event Consumer** is a background worker service that subscribes to the `naglfar-events` Redis pub/sub channel and processes events generated by the Naglfar Validation Service. It provides a foundation for building analytics pipelines, storing event data, and triggering business logic based on authentication events.

## Features

- ✅ Redis pub/sub subscription
- ✅ Generic event model for flexible message handling
- ✅ Automatic reconnection on Redis connection failure
- ✅ Structured logging with configurable levels
- ✅ Health checks for monitoring
- ✅ Docker support with Alpine Linux
- ✅ Comprehensive unit tests (11 tests passing)

## Technology Stack

- **Framework**: .NET 10.0 Worker Service
- **Redis Client**: StackExchange.Redis 2.10.1
- **Testing**: xUnit, Moq
- **Container**: Docker with Alpine Linux

## Event Format

The service consumes events in JSON format from the `naglfar-events` Redis channel:

```json
{
  "client_ip": "192.168.1.1",
  "store_id": "store-1",
  "action": "e-token",
  "timestamp": "2025-12-28T09:15:00.000Z"
}
```

The `NaglfartEvent` model is generic and can handle additional fields without code changes.

## Configuration

Configuration is managed through `appsettings.json` and environment variables:

### appsettings.json

```json
{
  "Redis": {
    "ConnectionString": "localhost:6379",
    "Channel": "naglfar-events",
    "RetryDelaySeconds": "5"
  }
}
```

### Environment Variables

Override configuration using environment variables with `__` (double underscore) as the delimiter:

- `Redis__ConnectionString` - Redis connection string (default: `localhost:6379`)
- `Redis__Channel` - Redis pub/sub channel (default: `naglfar-events`)
- `Redis__RetryDelaySeconds` - Retry delay on connection failure (default: `5`)
- `DOTNET_ENVIRONMENT` - Environment name (Development/Production)

## Local Development

### Prerequisites

- [.NET 10.0 SDK](https://dotnet.microsoft.com/download/dotnet/10.0)
- Redis server running locally or via Docker

### Run Locally

```bash
# Restore dependencies
dotnet restore

# Build the project
dotnet build

# Run the service
dotnet run --project src/NaglfartEventConsumer/NaglfartEventConsumer.csproj
```

### Run Tests

```bash
# Run all tests
dotnet test

# Run with detailed output
dotnet test --logger "console;verbosity=detailed"
```

## Docker

### Build Docker Image

```bash
# From project root
make docker-build-event-consumer

# Or manually
docker build -t naglfar-event-consumer:latest services/naglfar-event-consumer
```

### Run Docker Container

```bash
# Using make command
make docker-run-event-consumer

# Or manually
docker run -d --name naglfar-event-consumer \
  -e DOTNET_ENVIRONMENT=Development \
  -e Redis__ConnectionString=redis:6379 \
  -e Redis__Channel=naglfar-events \
  naglfar-event-consumer:latest
```

### Stop and Remove Container

```bash
make docker-stop-event-consumer
```

## Docker Compose

The service is included in the main `docker-compose.yml`:

```bash
# Start all services (from infrastructure directory)
cd infrastructure
docker-compose up -d

# View event consumer logs
docker-compose logs -f naglfar-event-consumer

# Rebuild and restart event consumer
make compose-rebuild-event-consumer
```

## Architecture

### Components

```
┌─────────────────────────────────────────────────────────────┐
│            Naglfar Event Consumer (.NET Worker)             │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RedisEventConsumer (BackgroundService)             │   │
│  │  - Subscribes to Redis channel                      │   │
│  │  - Auto-reconnect on failure                        │   │
│  │  - Processes incoming messages                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│                         ↓                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  NaglfartEvent Model (Generic)                      │   │
│  │  - Flexible property storage (Dictionary)           │   │
│  │  - Type-safe property accessors                     │   │
│  │  - Future-proof for new fields                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│                         ↓                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Business Logic (TODO)                              │   │
│  │  - Store in Neo4j                                   │   │
│  │  - Trigger analytics                                │   │
│  │  - Alert on patterns                                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                         │
                         ↓
               ┌──────────────────┐
               │  Redis Pub/Sub   │
               │  (naglfar-events)│
               └──────────────────┘
                         ↑
                         │
        ┌────────────────┴────────────────┐
        │                                 │
┌───────────────┐              ┌──────────────────┐
│   Naglfar     │              │  Auth Service    │
│   Validation  │              │  (Future)        │
│   Service     │              │                  │
└───────────────┘              └──────────────────┘
```

### Key Files

| File | Purpose |
|------|---------|
| `Program.cs` | Application entry point and service registration |
| `Services/RedisEventConsumer.cs` | Background service for Redis subscription |
| `Models/NaglfartEvent.cs` | Generic event model |
| `appsettings.json` | Production configuration |
| `appsettings.Development.json` | Development configuration |

## Logging

The service uses structured logging with different levels:

**Production** (appsettings.json):
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "NaglfartEventConsumer": "Information"
    }
  }
}
```

**Development** (appsettings.Development.json):
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "NaglfartEventConsumer": "Debug"
    }
  }
}
```

### Log Examples

```
info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Starting Redis Event Consumer: ConnectionString=redis:6379, Channel=naglfar-events

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Successfully connected to Redis

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Subscribed to Redis channel: naglfar-events

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Received message from Redis: {"client_ip":"192.168.1.1","store_id":"store-1","action":"e-token","timestamp":"2025-12-28T09:15:00.000Z"}

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Processing event: Action=e-token, ClientIp=192.168.1.1, StoreId=store-1, Timestamp=12/28/2025 09:15:00
```

## Error Handling

The service implements robust error handling:

1. **Connection Failures**: Automatic retry with configurable delay
2. **Message Processing Errors**: Logged but don't crash the service
3. **Graceful Shutdown**: Unsubscribes and disposes Redis connection

## Health Checks

The service includes a basic health check:

```csharp
builder.Services.AddHealthChecks()
    .AddCheck("redis_event_consumer", () =>
        HealthCheckResult.Healthy("Redis Event Consumer is running"));
```

Future improvements:
- Monitor Redis connection status
- Track message processing rate
- Expose health check endpoint

## Testing

### Unit Tests (11 tests)

Located in `tests/NaglfartEventConsumer.Tests/`:

- `NaglfartEventTests.cs` - Tests for the generic event model

```bash
# Run tests
dotnet test

# Output
Passed!  - Failed: 0, Passed: 11, Skipped: 0, Total: 11
```

### Integration Testing

To test the event consumer with real Redis:

```bash
# Start Redis
docker run -d --name redis -p 6379:6379 redis:8

# Start the event consumer
dotnet run --project src/NaglfartEventConsumer/NaglfartEventConsumer.csproj

# In another terminal, publish a test message
docker exec -it redis redis-cli
> PUBLISH naglfar-events '{"client_ip":"127.0.0.1","store_id":"store-1","action":"test","timestamp":"2025-12-28T10:00:00Z"}'
```

## Future Enhancements

- [ ] Store events in Neo4j graph database
- [ ] Implement event batching for performance
- [ ] Add Prometheus metrics
- [ ] Add health check endpoint (HTTP)
- [ ] Support multiple Redis channels
- [ ] Add event filtering and routing
- [ ] Implement dead-letter queue for failed messages
- [ ] Add support for event transformations

## Makefile Commands

Available commands (run `make help` from project root):

- `make docker-build-event-consumer` - Build Docker image
- `make docker-run-event-consumer` - Run Docker container
- `make docker-stop-event-consumer` - Stop and remove container
- `make docker-clean-event-consumer` - Remove Docker image
- `make compose-rebuild-event-consumer` - Rebuild via docker-compose
- `make test-event-consumer` - Run tests

## Contributing

When making changes:

1. Update this README if adding new features
2. Add unit tests for new functionality
3. Update CHANGELOG.md with changes
4. Run tests before committing: `dotnet test`

## License

This project is part of the Naglfar Analytics system.
