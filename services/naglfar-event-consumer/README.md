# Naglfar Event Consumer

A .NET 10.0 Worker Service that consumes E-TOKEN events from Redis pub/sub and processes them for analytics.

## Overview

The **Naglfar Event Consumer** is a background worker service that subscribes to the `naglfar-events` Redis pub/sub channel and processes events generated by the Naglfar Validation Service. It provides a foundation for building analytics pipelines, storing event data, and triggering business logic based on authentication events.

## Features

- ✅ Redis pub/sub subscription
- ✅ Generic event model for flexible message handling
- ✅ Automatic reconnection on Redis connection failure
- ✅ Structured logging with configurable levels
- ✅ Health checks for monitoring
- ✅ Docker support with Alpine Linux
- ✅ Comprehensive unit tests (11 tests passing)

## Technology Stack

- **Framework**: .NET 10.0 Worker Service
- **Redis Client**: StackExchange.Redis 2.10.1
- **Testing**: xUnit, Moq
- **Container**: Docker with Alpine Linux

## Event Format

The service consumes events in JSON format from the `naglfar-events` Redis channel:

```json
{
  "client_ip": "192.168.1.1",
  "store_id": "store-1",
  "action": "e-token",
  "timestamp": "2025-12-28T09:15:00.000Z"
}
```

The `NaglfartEvent` model is generic and can handle additional fields without code changes.

## Configuration

Configuration is managed through `appsettings.json` and environment variables:

### appsettings.json

```json
{
  "Redis": {
    "ConnectionString": "localhost:6379",
    "Channel": "naglfar-events",
    "RetryDelaySeconds": "5"
  }
}
```

### Environment Variables

Override configuration using environment variables with `__` (double underscore) as the delimiter:

**Redis Configuration**:
- `Redis__ConnectionString` - Redis connection string (default: `localhost:6379`)
- `Redis__Channel` - Redis pub/sub channel (default: `naglfar-events`)
- `Redis__RetryDelaySeconds` - Retry delay on connection failure (default: `5`)

**Logging Configuration**:
- `Logging__LogLevel__Default` - Default log level (default: `Information`)
- `Logging__LogLevel__NaglfartEventConsumer` - Service-specific log level (default: `Information` in Production, `Debug` in Development)
- `Logging__LogLevel__Microsoft.Hosting.Lifetime` - Host lifetime log level (default: `Information`)

**Available Log Levels**: `Trace`, `Debug`, `Information`, `Warning`, `Error`, `Critical`, `None`

**Environment**:
- `DOTNET_ENVIRONMENT` - Environment name (Development/Production)
- `ASPNETCORE_URLS` - HTTP endpoints (default: `http://+:8080`)

## Local Development

### Prerequisites

- [.NET 10.0 SDK](https://dotnet.microsoft.com/download/dotnet/10.0)
- Redis server running locally or via Docker

### Run Locally

```bash
# Restore dependencies
dotnet restore

# Build the project
dotnet build

# Run the service
dotnet run --project src/NaglfartEventConsumer/NaglfartEventConsumer.csproj
```

### Run Tests

```bash
# Run all tests
dotnet test

# Run with detailed output
dotnet test --logger "console;verbosity=detailed"
```

## Docker

### Build Docker Image

```bash
# From project root
make docker-build-event-consumer

# Or manually
docker build -t naglfar-event-consumer:latest services/naglfar-event-consumer
```

### Run Docker Container

```bash
# Using make command
make docker-run-event-consumer

# Or manually
docker run -d --name naglfar-event-consumer \
  -e DOTNET_ENVIRONMENT=Development \
  -e Redis__ConnectionString=redis:6379 \
  -e Redis__Channel=naglfar-events \
  naglfar-event-consumer:latest
```

### Stop and Remove Container

```bash
make docker-stop-event-consumer
```

## Docker Compose

The service is included in the main `docker-compose.yml`:

```bash
# Start all services (from infrastructure directory)
cd infrastructure
docker-compose up -d

# View event consumer logs
docker-compose logs -f naglfar-event-consumer

# Rebuild and restart event consumer
make compose-rebuild-event-consumer
```

## Prometheus Metrics

The service exposes Prometheus metrics at `http://localhost:8083/metrics` for monitoring event processing.

### Metrics Endpoint

- **URL**: `http://localhost:8083/metrics`
- **Port**: 8083 (mapped from container port 8080)
- **Format**: Prometheus text format

### Available Metrics

#### 1. Events Processed Counter

**Metric Name**: `naglfar_events_processed_total`

**Type**: Counter

**Description**: Total number of events processed from Redis pub/sub

**Labels**:
- `action` - Type of event (e.g., "e-token", "auth-token")
- `store_id` - Store identifier (e.g., "store-1", "store-2", ...)

**Example**:
```
# HELP naglfar_events_processed_total Total number of events processed from Redis pub/sub
# TYPE naglfar_events_processed_total counter
naglfar_events_processed_total{action="e-token",store_id="store-1"} 42
naglfar_events_processed_total{action="e-token",store_id="store-2"} 15
naglfar_events_processed_total{action="auth-token",store_id="store-1"} 8
```

**Use Cases**:
- Track total events processed by type
- Monitor event volume per store
- Alert on unusual event patterns
- Calculate event processing rate

#### 2. Event Processing Errors Counter

**Metric Name**: `naglfar_events_processing_errors_total`

**Type**: Counter

**Description**: Total number of events that failed to process

**Labels**:
- `action` - Type of event that failed
- `error_type` - Exception type (e.g., "JsonException", "TimeoutException")

**Example**:
```
# HELP naglfar_events_processing_errors_total Total number of events that failed to process
# TYPE naglfar_events_processing_errors_total counter
naglfar_events_processing_errors_total{action="unknown",error_type="JsonException"} 2
```

**Use Cases**:
- Monitor error rates
- Alert on processing failures
- Identify problematic event types
- Track error types for debugging

#### 3. Redis Connection Status Gauge

**Metric Name**: `naglfar_redis_connection_status`

**Type**: Gauge

**Description**: Status of Redis connection (1 = connected, 0 = disconnected)

**Example**:
```
# HELP naglfar_redis_connection_status Status of Redis connection (1 = connected, 0 = disconnected)
# TYPE naglfar_redis_connection_status gauge
naglfar_redis_connection_status 1
```

**Use Cases**:
- Monitor Redis connectivity
- Alert on connection failures
- Track connection stability
- Correlate with event processing issues

### Prometheus Configuration

Add the following to your `prometheus.yml`:

```yaml
scrape_configs:
  - job_name: 'naglfar-event-consumer'
    static_configs:
      - targets: ['naglfar-event-consumer:8080']
    # Or if running locally:
    # - targets: ['localhost:8083']
    scrape_interval: 15s
    scrape_timeout: 10s
```

### Example Queries

**Total events processed**:
```promql
sum(naglfar_events_processed_total)
```

**Events per action type**:
```promql
sum by (action) (naglfar_events_processed_total)
```

**Events per store**:
```promql
sum by (store_id) (naglfar_events_processed_total)
```

**Event processing rate (events/sec)**:
```promql
rate(naglfar_events_processed_total[5m])
```

**Error rate percentage**:
```promql
sum(rate(naglfar_events_processing_errors_total[5m]))
/
sum(rate(naglfar_events_processed_total[5m])) * 100
```

**Redis connection uptime**:
```promql
avg_over_time(naglfar_redis_connection_status[1h])
```

### Grafana Dashboard

Import these panels into Grafana:

1. **Event Processing Rate** - Graph showing `rate(naglfar_events_processed_total[5m])`
2. **Events by Action** - Pie chart of `sum by (action) (naglfar_events_processed_total)`
3. **Events by Store** - Bar chart of `sum by (store_id) (naglfar_events_processed_total)`
4. **Error Rate** - Graph showing error percentage over time
5. **Redis Connection Status** - Single stat showing connection status

## Architecture

### Components

```
┌─────────────────────────────────────────────────────────────┐
│            Naglfar Event Consumer (.NET Worker)             │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RedisEventConsumer (BackgroundService)             │   │
│  │  - Subscribes to Redis channel                      │   │
│  │  - Auto-reconnect on failure                        │   │
│  │  - Processes incoming messages                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│                         ↓                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  NaglfartEvent Model (Generic)                      │   │
│  │  - Flexible property storage (Dictionary)           │   │
│  │  - Type-safe property accessors                     │   │
│  │  - Future-proof for new fields                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│                         ↓                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Business Logic (TODO)                              │   │
│  │  - Store in Neo4j                                   │   │
│  │  - Trigger analytics                                │   │
│  │  - Alert on patterns                                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                         │
                         ↓
               ┌──────────────────┐
               │  Redis Pub/Sub   │
               │  (naglfar-events)│
               └──────────────────┘
                         ↑
                         │
        ┌────────────────┴────────────────┐
        │                                 │
┌───────────────┐              ┌──────────────────┐
│   Naglfar     │              │  Auth Service    │
│   Validation  │              │  (Future)        │
│   Service     │              │                  │
└───────────────┘              └──────────────────┘
```

### Key Files

| File | Purpose |
|------|---------|
| `Program.cs` | Application entry point and service registration |
| `Services/RedisEventConsumer.cs` | Background service for Redis subscription |
| `Models/NaglfartEvent.cs` | Generic event model |
| `appsettings.json` | Production configuration |
| `appsettings.Development.json` | Development configuration |

## Logging

The service uses structured logging with different levels that can be configured via environment variables.

### Configuration

**From docker-compose.yml** (Recommended):

Edit `infrastructure/docker-compose.yml` to change logging levels:

```yaml
naglfar-event-consumer:
  environment:
    # Set to Debug for verbose logging
    - Logging__LogLevel__Default=Debug
    - Logging__LogLevel__NaglfartEventConsumer=Debug

    # Or set to Warning for minimal logging
    # - Logging__LogLevel__Default=Warning
    # - Logging__LogLevel__NaglfartEventConsumer=Warning
```

**Available Log Levels** (from most to least verbose):
- `Trace` - Very detailed logs, may include sensitive data
- `Debug` - Detailed flow and diagnostic information
- `Information` - General informational messages (default)
- `Warning` - Abnormal or unexpected events
- `Error` - Errors and exceptions
- `Critical` - Critical failures
- `None` - Disable logging

**Default Configuration**:

Production (appsettings.json):
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "NaglfartEventConsumer": "Information"
    }
  }
}
```

Development (appsettings.Development.json):
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "NaglfartEventConsumer": "Debug"
    }
  }
}
```

**Note**: Environment variables in docker-compose.yml override appsettings.json values.

### Log Examples

```
info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Starting Redis Event Consumer: ConnectionString=redis:6379, Channel=naglfar-events

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Successfully connected to Redis

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Subscribed to Redis channel: naglfar-events

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Received message from Redis: {"client_ip":"192.168.1.1","store_id":"store-1","action":"e-token","timestamp":"2025-12-28T09:15:00.000Z"}

info: NaglfartEventConsumer.Services.RedisEventConsumer[0]
      Processing event: Action=e-token, ClientIp=192.168.1.1, StoreId=store-1, Timestamp=12/28/2025 09:15:00
```

## Error Handling

The service implements robust error handling:

1. **Connection Failures**: Automatic retry with configurable delay
2. **Message Processing Errors**: Logged but don't crash the service
3. **Graceful Shutdown**: Unsubscribes and disposes Redis connection

## Health Checks

The service includes a basic health check:

```csharp
builder.Services.AddHealthChecks()
    .AddCheck("redis_event_consumer", () =>
        HealthCheckResult.Healthy("Redis Event Consumer is running"));
```

Future improvements:
- Monitor Redis connection status
- Track message processing rate
- Expose health check endpoint

## Testing

### Unit Tests (11 tests)

Located in `tests/NaglfartEventConsumer.Tests/`:

- `NaglfartEventTests.cs` - Tests for the generic event model

```bash
# Run tests
dotnet test

# Output
Passed!  - Failed: 0, Passed: 11, Skipped: 0, Total: 11
```

### Integration Testing

To test the event consumer with real Redis:

```bash
# Start Redis
docker run -d --name redis -p 6379:6379 redis:8

# Start the event consumer
dotnet run --project src/NaglfartEventConsumer/NaglfartEventConsumer.csproj

# In another terminal, publish a test message
docker exec -it redis redis-cli
> PUBLISH naglfar-events '{"client_ip":"127.0.0.1","store_id":"store-1","action":"test","timestamp":"2025-12-28T10:00:00Z"}'
```

## Future Enhancements

- [ ] Store events in Neo4j graph database
- [ ] Implement event batching for performance
- [ ] Add Prometheus metrics
- [ ] Add health check endpoint (HTTP)
- [ ] Support multiple Redis channels
- [ ] Add event filtering and routing
- [ ] Implement dead-letter queue for failed messages
- [ ] Add support for event transformations

## Makefile Commands

Available commands (run `make help` from project root):

- `make docker-build-event-consumer` - Build Docker image
- `make docker-run-event-consumer` - Run Docker container
- `make docker-stop-event-consumer` - Stop and remove container
- `make docker-clean-event-consumer` - Remove Docker image
- `make compose-rebuild-event-consumer` - Rebuild via docker-compose
- `make test-event-consumer` - Run tests

## Contributing

When making changes:

1. Update this README if adding new features
2. Add unit tests for new functionality
3. Update CHANGELOG.md with changes
4. Run tests before committing: `dotnet test`

## License

This project is part of the Naglfar Analytics system.
